name: Security Audit

on:
  push:
    branches: [main, dev]
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: [main]
  schedule:
    # æ¯å‘¨ä¸€ UTC 00:00 è¿è¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm (corepack)
        run: |
          set -euo pipefail
          corepack enable
          corepack prepare pnpm@10.23.0 --activate
          pnpm -v

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è¿è¡Œå®¡è®¡å¹¶æ•èŽ·è¾“å‡º
          if pnpm audit --audit-level=high 2>&1 | tee audit-output.txt; then
            echo "âœ… No high or critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat audit-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # å¦‚æžœæœ‰ critical æ¼æ´žåˆ™å¤±è´¥
            if grep -q "critical" audit-output.txt; then
              echo "âŒ Critical vulnerabilities found - blocking merge" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            
            # high æ¼æ´žåªè­¦å‘Šä¸é˜»å¡ž
            echo "âš ï¸ High vulnerabilities found - review required" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for outdated dependencies
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pnpm outdated 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || true
