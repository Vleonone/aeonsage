# ============================================================================
# AeonSage Quickstart Docker Compose
# ============================================================================
# 新手一键启动配置 / Beginner-friendly one-command setup
#
# 使用方法 / Usage:
#   docker compose -f docker-compose.quickstart.yml up
#
# 首次运行将自动:
# - 构建 Docker 镜像
# - 生成安全 Token
# - 启动 Gateway 服务
# - 打开 Control UI: http://localhost:18789
# ============================================================================

services:
  # ==========================================================================
  # AeonSage Gateway - 核心服务
  # ==========================================================================
  aeonsage:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aeonsage-quickstart
    environment:
      HOME: /home/node
      TERM: xterm-256color
      # 自动生成 Token (首次运行)
      AEONSAGE_GATEWAY_TOKEN: ${AEONSAGE_GATEWAY_TOKEN:-}
      # AI Provider Keys (从 .env 读取)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GOOGLE_AI_API_KEY: ${GOOGLE_AI_API_KEY:-}
      # Channel Tokens
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN:-}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN:-}
    volumes:
      # 配置持久化
      - aeonsage-config:/home/node/.aeonsage
      # 工作区持久化
      - aeonsage-workspace:/home/node/aeonsage-workspace
    ports:
      # Control UI + WebSocket
      - "18789:18789"
      # Bridge (iOS/Android nodes)
      - "18790:18790"
    init: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "dist/index.js", "health", "--json"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind", "lan",
        "--port", "18789",
        "--verbose"
      ]

# ============================================================================
# Volumes - 数据持久化
# ============================================================================
volumes:
  aeonsage-config:
    name: aeonsage-config
  aeonsage-workspace:
    name: aeonsage-workspace
